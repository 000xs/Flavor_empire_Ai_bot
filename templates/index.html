<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flavor Emperor AI Studio</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Flavor Emperor AI Studio</h1>
            <p>Transform culinary ideas into stunning blog posts with AI-powered content generation.</p>
        </header>

        <main>
            <section class="main-action-area">
                <button id="create-post-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Create New Post
                </button>
                <div id="status-message" class="status-message hidden"></div>
            </section>

            <section class="task-list">
                <h2>Recent Publications</h2>
                <div id="posts-container">
                    <!-- Posts will be loaded here -->
                </div>
            </section>
        </main>

        <footer class="dashboard-footer">
            <p>âœ¨ AI-Powered Culinary Content Studio v1.0</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const createPostBtn = document.getElementById('create-post-btn');
            const postsContainer = document.getElementById('posts-container');
            const statusMessageDiv = document.getElementById('status-message');

            function showStatus(message, isError = false) {
                statusMessageDiv.textContent = message;
                statusMessageDiv.classList.remove('hidden');
                if (isError) {
                    statusMessageDiv.classList.add('error-message');
                } else {
                    statusMessageDiv.classList.remove('error-message');
                }
            }

            function hideStatus() {
                statusMessageDiv.classList.add('hidden');
                statusMessageDiv.classList.remove('error-message');
                statusMessageDiv.textContent = '';
            }

            async function fetchPosts() {
                postsContainer.innerHTML = '<div class="loader"></div>'; // Show loader while fetching
                try {
                    const response = await fetch('/api/posts');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const responseData = await response.json();
                    const posts = responseData[1]; // Access the second element of the array

                    if (!Array.isArray(posts)) {
                        throw new Error("Invalid data format received from server.");
                    }

                    postsContainer.innerHTML = ''; // Clear existing posts
                    if (posts.length > 0) {
                        posts.forEach(post => {
                            const postElement = document.createElement('div');
                            postElement.classList.add('post-card');
                            postElement.innerHTML = `
                                ${post.image_url ? `<img src="${post.image_url}" alt="${post.title}">` : ''}
                                <h3>${post.title}</h3>
                                ${post.post_url ? `<p><a href="${post.post_url}" target="_blank">View Published Post</a></p>` : '<p>Not published yet.</p>'}
                            `;
                            postsContainer.appendChild(postElement);
                        });
                    } else {
                        postsContainer.innerHTML = '<p class="status-message">No posts found. Click "Create New Post" to get started!</p>';
                    }
                } catch (error) {
                    console.error('Error fetching tasks:', error);
                    postsContainer.innerHTML = `<p class="error-message">Error loading posts: ${error.message}. Please ensure Supabase is configured correctly and the 'tasks' table exists.</p>`;
                }
            }

            async function createPost() {
                createPostBtn.disabled = true;
                createPostBtn.innerHTML = '<span class="btn-loader"></span> Generating...';
                hideStatus(); // Hide previous status if any

                try {
                    showStatus('Generating topic...');
                    const response = await fetch('/api/scheduled-call');
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to create post');
                    }
                    
                    console.log('Post creation result:', result);
                    showStatus('Post created and published successfully!');
                    await fetchPosts(); // Refresh the posts list
                } catch (error) {
                    console.error('Error creating post:', error);
                    showStatus(`Failed to create post: ${error.message}. Check console for details.`, true);
                } finally {
                    createPostBtn.disabled = false;
                    createPostBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Create New Post';
                }
            }

            createPostBtn.addEventListener('click', createPost);

            // Initial load of posts
            fetchPosts();
        });
    </script>
</body>
</html>
