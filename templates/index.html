<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flavor Emperor AI Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Flavor Emperor AI Dashboard</h1>
            <p>Create and manage your AI-generated food blog posts.</p>
        </header>

        <main>
            <div class="controls">
                <button id="create-post-btn">Create New Blog Post</button>
            </div>

            <section class="task-list">
                <h2>Generated Posts</h2>
                <div id="posts-container">
                    <!-- Posts will be loaded here -->
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const createPostBtn = document.getElementById('create-post-btn');
            const postsContainer = document.getElementById('posts-container');

            async function fetchPosts() {
                postsContainer.innerHTML = '<div class="loader"></div>'; // Show loader while fetching
                try {
                    const response = await fetch('/api/posts');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const posts = await response.json();

                    if (!Array.isArray(posts)) {
                        // If it's not an array, it might be an error object from Flask's jsonify({"error": ...})
                        if (posts && posts.error) {
                            throw new Error(`Server error: ${posts.error}`);
                        }
                        throw new Error("Invalid data format received from server. Expected an array of posts.");
                    }

                    postsContainer.innerHTML = ''; // Clear existing posts
                    if (posts.length > 0) {
                        posts.forEach(post => {
                            const postElement = document.createElement('div');
                            postElement.classList.add('post-card');
                            postElement.innerHTML = `
                                <h3>${post.title}</h3>
                                ${post.post_url ? `<p><a href="${post.post_url}" target="_blank">View Published Post</a></p>` : '<p>Not published yet.</p>'}
                                ${post.image_url ? `<img src="${post.image_url}" alt="${post.title}" style="max-width: 100%; height: auto; margin-top: 10px; border-radius: 5px;">` : ''}
                            `;
                            postsContainer.appendChild(postElement);
                        });
                    } else {
                        postsContainer.innerHTML = '<p>No tasks found. Create one to get started!</p>';
                    }
                } catch (error) {
                    console.error('Error fetching tasks:', error);
                    postsContainer.innerHTML = `<p class="error-message">Error loading tasks: ${error.message}. Please ensure Supabase is configured correctly and the 'tasks' table exists.</p>`;
                }
            }

            async function createPost() {
                createPostBtn.disabled = true;
                createPostBtn.innerHTML = '<div class="loader" style="width: 20px; height: 20px; border-width: 3px; margin: 0 auto;"></div>';

                try {
                    const response = await fetch('/api/scheduled-call');
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to create post');
                    }
                    
                    console.log('Post creation result:', result);
                    // No alert, just refresh the list to show the new post
                    await fetchPosts();
                } catch (error) {
                    console.error('Error creating post:', error);
                    alert(`Failed to create post: ${error.message}. Check console for details.`);
                } finally {
                    createPostBtn.disabled = false;
                    createPostBtn.innerHTML = 'Create New Blog Post';
                }
            }

            createPostBtn.addEventListener('click', createPost);

            // Initial load of posts
            fetchPosts();
        });
    </script>
</body>
</html>
