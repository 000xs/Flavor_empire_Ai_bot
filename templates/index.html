<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flavor Emperor AI Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Flavor Emperor AI Dashboard</h1>
            <p>Create and manage your AI-generated food blog posts.</p>
        </header>

        <main>
            <div class="controls">
                <button id="create-post-btn">Create New Blog Post</button>
            </div>

            <section class="task-list">
                <h2>Generated Posts</h2>
                <div id="posts-container">
                    <!-- Posts will be loaded here -->
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const createPostBtn = document.getElementById('create-post-btn');
            const postsContainer = document.getElementById('posts-container');

            async function fetchPosts() {
                try {
                    const response = await fetch('/api/posts');
                    if (!response.ok) {
                        throw new Error('Failed to fetch posts');
                    }
                    const responseData = await response.json();
                    
                    // Supabase returns data as [data, count]
                    const posts = responseData[0]; 

                    postsContainer.innerHTML = ''; // Clear existing posts
                    if (posts && posts.length > 0) {
                        posts.forEach(post => {
                            const postElement = document.createElement('div');
                            postElement.classList.add('post-card');
                            postElement.innerHTML = `
                                <h3>${post.title}</h3>
                                <p><strong>Status:</strong> ${post.published ? 'Published' : 'Draft'}</p>
                                ${post.image_url ? `<img src="${post.image_url}" alt="${post.title}" style="max-width: 100%; height: auto; margin-top: 10px;">` : ''}
                            `;
                            postsContainer.appendChild(postElement);
                        });
                    } else {
                        postsContainer.innerHTML = '<p>No posts found.</p>';
                    }
                } catch (error) {
                    console.error('Error fetching posts:', error);
                    postsContainer.innerHTML = `<p class="error-message">Error loading posts: ${error.message}. Please ensure Supabase is configured correctly and the 'posts' table exists.</p>`;
                }
            }

            async function createPost() {
                createPostBtn.disabled = true;
                createPostBtn.textContent = 'Creating Post...';
                postsContainer.innerHTML = '<p>Generating new post, please wait...</p>'; // Show loading message

                try {
                    const response = await fetch('/api/scheduled-call');
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to create post');
                    }
                    
                    console.log('Post creation result:', result);
                    alert('Blog post created successfully!'); // Success message
                    await fetchPosts(); // Refresh the posts list
                } catch (error) {
                    console.error('Error creating post:', error);
                    alert(`Failed to create post: ${error.message}. Check console for details.`);
                    postsContainer.innerHTML = `<p class="error-message">Failed to create post: ${error.message}</p>`; // Show error message
                } finally {
                    createPostBtn.disabled = false;
                    createPostBtn.textContent = 'Create New Blog Post';
                }
            }

            createPostBtn.addEventListener('click', createPost);

            // Initial load of posts
            fetchPosts();
        });
    </script>
</body>
</html>
